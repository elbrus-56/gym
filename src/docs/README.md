# Документация по проекту Proxy Manager

## Описание

Этот проект представляет собой микросервис для управления списком прокси-серверов. Он позволяет добавлять, просматривать, удалять и проверять статус прокси.

## Структура проекта

Проект использует архитектуру Vertical Slice (фича-ориентированный подход).

-   `core/`: Содержит доменные модели и общие интерфейсы (например, репозитории).
    -   `domain/`: Доменные сущности (например, `ProxyServer`).
    -   `repositories/`: Абстрактные интерфейсы репозиториев.
-   `features/`: Каждый подкаталог представляет отдельную фичу (вертикальный срез).
    -   `<feature_name>/`:
        -   `handler.py`: Обработчик HTTP-запросов (FastAPI эндпоинт).
        -   `use_case.py`: Логика фичи (бизнес-логика).
        -   `command.py`/`query.py`/`dto.py`: Объекты передачи данных (DTO) или команды/запросы.
-   `infrastructure/`: Содержит реализации инфраструктурных компонентов.
    -   `database/`: Настройки подключения к БД, модели SQLAlchemy.
    -   `repositories/`: Реализации репозиториев (например, `SQLAlchemyProxyRepository`).
    -   `http_client/`: Клиент для выполнения HTTP-запросов (для проверки прокси).
-   `tests/`: Тесты для проекта.
-   `main.py`: Точка входа в приложение FastAPI, настройка роутеров, зависимостей.
-   `config.py`: Загрузка и управление конфигурацией (из `.env`).
-   `docker-compose.yml`: Настройка Docker-контейнеров.
-   `Dockerfile`: Инструкции по сборке Docker-образа приложения.
-   `requirements.txt`: Зависимости Python.
-   `plan.md`: План разработки проекта.

## Настройка и Запуск

### Требования

-   Python 3.10+
-   Docker (рекомендуется)

### Локальный запуск (без Docker)

1.  **Клонируйте репозиторий:**
    ```bash
    git clone <URL_репозитория>
    cd proxy_server
    ```
2.  **Создайте и активируйте виртуальное окружение:**
    ```bash
    python -m venv venv
    source venv/bin/activate # Linux/macOS
    # venv\Scripts\activate # Windows
    ```
3.  **Установите зависимости:**
    ```bash
    pip install -r requirements.txt
    ```
4.  **Настройте переменные окружения:**
    Создайте файл `.env` в корне проекта по примеру `.env.example` и укажите необходимые значения (например, `DATABASE_URL`).
5.  **Примените миграции базы данных:**
    ```bash
    alembic upgrade head
    ```
6.  **Запустите приложение:**
    ```bash
    uvicorn main:app --reload
    ```
    Приложение будет доступно по адресу `http://127.0.0.1:8000`.

### Запуск с Docker

1.  **Клонируйте репозиторий:** (если еще не сделали)
    ```bash
    git clone <URL_репозитория>
    cd proxy_server
    ```
2.  **Настройте переменные окружения:**
    Создайте файл `.env` в корне проекта по примеру `.env.example`.
3.  **Соберите и запустите контейнеры:**
    ```bash
    docker-compose up --build -d
    ```
    Приложение будет доступно по адресу `http://127.0.0.1:8000` (или порту, указанному в `docker-compose.yml`).

## Конфигурация

Настройки приложения управляются через переменные окружения, загружаемые из файла `.env`. Основные параметры:

-   `DATABASE_URL`: Строка подключения к базе данных (например, `sqlite+aiosqlite:///./proxy.db`).
-   `CHECK_PROXY_TIMEOUT_SECONDS`: Таймаут для проверки прокси (в секундах).
-   `CHECK_PROXY_INTERVAL_MINUTES`: Интервал для фоновой проверки прокси (в минутах, 0 - отключить).
-   `PROXY_CHECK_URL`: URL для проверки работоспособности прокси (например, `https://httpbin.org/ip`).

## API Endpoints

Подробная спецификация API доступна в формате OpenAPI по адресу `/docs` (Swagger UI) или `/redoc` (ReDoc) при запущенном приложении.

Основные эндпоинты:

-   `POST /proxies`: Добавить новый прокси.
-   `GET /proxies`: Получить список прокси (с возможностью фильтрации).
-   `DELETE /proxies/{proxy_id}`: Удалить прокси по ID.
-   `GET /proxies/{proxy_id}/check`: Проверить статус конкретного прокси.
-   `GET /proxies/random`: Получить случайный рабочий прокси.

## Тестирование

Для запуска тестов выполните:

```bash
pytest
```

Тесты находятся в директории `tests/`. Используется `pytest` и `httpx` для интеграционного тестирования API.

## База данных

По умолчанию используется SQLite. Структура базы данных определяется моделями SQLAlchemy в `infrastructure/database/models.py`. Управление версиями схемы базы данных осуществляется с помощью Alembic.

Для создания новой миграции (после изменения моделей):
```bash
alembic revision --autogenerate -m "Краткое описание изменений"
```

Для применения миграций:
```bash
alembic upgrade head
```

Настройки Alembic находятся в файле `alembic.ini` и скриптах в директории `alembic/`.

## Фоновая проверка прокси

Если `CHECK_PROXY_INTERVAL_MINUTES` установлено в значение больше 0, приложение будет периодически проверять статус всех прокси в фоновом режиме и обновлять их статус в базе данных.
